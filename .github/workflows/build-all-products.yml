name: Build All iTechSmart Products

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build Type'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - demo
          - suite
      version:
        description: 'Version Number'
        required: false
        default: 'auto'

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '20'

jobs:
  prepare:
    name: Prepare Build Environment
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      products: ${{ steps.products.outputs.list }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.event.inputs.version }}" != "" && "${{ github.event.inputs.version }}" != "auto" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION="$(date +%Y.%m.%d)-$(git rev-parse --short HEAD)"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Identify products
        id: products
        run: |
          PRODUCTS=$(find . -maxdepth 1 -type d \( -name "itechsmart-*" -o -name "legalai-pro" -o -name "prooflink" -o -name "passport" \) | sed 's|^\./||' | jq -R -s -c 'split("\n")[:-1]')
          echo "list=$PRODUCTS" >> $GITHUB_OUTPUT
          echo "Products found: $PRODUCTS"
          
      - name: Validate products
        run: |
          echo "Validating product structure..."
          PRODUCTS=$(find . -maxdepth 1 -type d \( -name "itechsmart-*" -o -name "legalai-pro" -o -name "prooflink" -o -name "passport" \))
          
          for product in $PRODUCTS; do
            product_name=$(basename "$product")
            echo "Checking $product_name..."
            
            if [ -d "$product" ]; then
              echo "  ✓ Directory exists"
              
              # Check for backend
              if [ -d "$product/backend" ]; then
                echo "  ✓ Backend directory found"
              else
                echo "  ⚠ Backend directory not found"
              fi
              
              # Check for frontend
              if [ -d "$product/frontend" ]; then
                echo "  ✓ Frontend directory found"
              else
                echo "  ⚠ Frontend directory not found"
              fi
            fi
          done
          
          echo ""
          echo "Product validation complete!"
          echo "Total products found: $(echo "$PRODUCTS" | wc -l)"

  validate-build-tools:
    name: Validate Build Tools
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Check build tools
        run: |
          echo "Checking build tools..."
          
          if [ -d "build-tools" ]; then
            echo "✓ build-tools directory exists"
            echo ""
            echo "Build scripts found:"
            ls -1 build-tools/*.py
          else
            echo "✗ build-tools directory not found"
            exit 1
          fi

      - name: Validate Python syntax
        run: |
          echo "Validating Python build scripts..."
          python -m py_compile build-tools/*.py
          echo "✓ All build scripts have valid syntax"

  summary:
    name: Build Summary
    needs: [prepare, validate-build-tools]
    runs-on: ubuntu-latest
    steps:
      - name: Display summary
        run: |
          echo "=========================================="
          echo "iTechSmart Suite Build Summary"
          echo "=========================================="
          echo ""
          echo "Version: ${{ needs.prepare.outputs.version }}"
          echo "Products: $(echo '${{ needs.prepare.outputs.products }}' | jq -r '. | length')"
          echo ""
          echo "Products list:"
          echo '${{ needs.prepare.outputs.products }}' | jq -r '.[]' | sed 's/^/  - /'
          echo ""
          echo "=========================================="
          echo "✓ Validation Complete"
          echo "=========================================="
          echo ""
          echo "Note: Full builds are disabled until build environment is configured."
          echo "To enable builds, ensure:"
          echo "  1. src/license-system directory exists"
          echo "  2. src/auto-update directory exists"
          echo "  3. Each product has backend/main.py entry point"