// Prisma Schema for iTechSmart License Server

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Organizations (Companies/Customers)
model Organization {
  id            String   @id @default(uuid())
  name          String
  domain        String   @unique
  email         String
  phone         String?
  address       String?
  country       String?
  
  // Billing
  stripeCustomerId String? @unique
  
  // Metadata
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  licenses      License[]
  users         User[]
  apiKeys       ApiKey[]
  usage         UsageRecord[]
  agents        Agent[]
  
  @@index([domain])
  @@index([email])
}

// License Tiers
enum LicenseTier {
  TRIAL
  STARTER
  PROFESSIONAL
  ENTERPRISE
  UNLIMITED
}

// License Status
enum LicenseStatus {
  ACTIVE
  SUSPENDED
  EXPIRED
  CANCELLED
}

// Licenses
model License {
  id              String        @id @default(uuid())
  licenseKey      String        @unique
  
  // Organization
  organizationId  String
  organization    Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // License Details
  tier            LicenseTier
  status          LicenseStatus @default(ACTIVE)
  
  // Limits
  maxUsers        Int           @default(5)
  maxProducts     Int           @default(3)
  maxApiCalls     Int           @default(10000)  // per day
  maxStorage      BigInt        @default(10737418240) // 10 GB in bytes
  
  // Products Access (JSON array of product IDs)
  allowedProducts Json          @default("[]")
  
  // Features
  features        Json          @default("{}")
  
  // Validity
  startDate       DateTime      @default(now())
  expiresAt       DateTime?
  
  // Trial
  isTrial         Boolean       @default(false)
  trialEndsAt     DateTime?
  
  // Machine Locking (for desktop apps)
  machineIds      Json          @default("[]")
  maxMachines     Int           @default(1)
  
  // Metadata
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  lastValidated   DateTime?
  
  // Relations
  validations     LicenseValidation[]
  usage           UsageRecord[]
  agents          Agent[]
  
  @@index([organizationId])
  @@index([licenseKey])
  @@index([status])
  @@index([tier])
}

// Users (for organization access)
model User {
  id              String        @id @default(uuid())
  email           String        @unique
  passwordHash    String
  name            String
  role            String        @default("user") // admin, user, viewer
  
  // Organization
  organizationId  String
  organization    Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Status
  isActive        Boolean       @default(true)
  emailVerified   Boolean       @default(false)
  
  // Metadata
  lastLogin       DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  // Relations
  apiKeys         ApiKey[]
  
  @@index([organizationId])
  @@index([email])
}

// API Keys (for programmatic access)
model ApiKey {
  id              String        @id @default(uuid())
  key             String        @unique
  name            String
  
  // Owner
  organizationId  String
  organization    Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  userId          String?
  user            User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  // Permissions
  scopes          Json          @default("[]") // ["read", "write", "admin"]
  
  // Status
  isActive        Boolean       @default(true)
  expiresAt       DateTime?
  
  // Usage
  lastUsed        DateTime?
  usageCount      Int           @default(0)
  
  // Metadata
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@index([organizationId])
  @@index([key])
}

// License Validations (audit log)
model LicenseValidation {
  id              String        @id @default(uuid())
  
  // License
  licenseId       String
  license         License       @relation(fields: [licenseId], references: [id], onDelete: Cascade)
  
  // Validation Details
  isValid         Boolean
  reason          String?
  
  // Request Info
  ipAddress       String?
  userAgent       String?
  machineId       String?
  productId       String?
  
  // Metadata
  validatedAt     DateTime      @default(now())
  
  @@index([licenseId])
  @@index([validatedAt])
}

// Usage Records (for metering)
model UsageRecord {
  id              String        @id @default(uuid())
  
  // Organization & License
  organizationId  String
  organization    Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  licenseId       String
  license         License       @relation(fields: [licenseId], references: [id], onDelete: Cascade)
  
  // Usage Details
  productId       String
  eventType       String        // api_call, storage_used, user_login, etc.
  quantity        Int           @default(1)
  
  // Metadata
  metadata        Json          @default("{}")
  recordedAt      DateTime      @default(now())
  
  @@index([organizationId])
  @@index([licenseId])
  @@index([productId])
  @@index([recordedAt])
}

// Pricing Plans (for reference)
model PricingPlan {
  id              String        @id @default(uuid())
  name            String        @unique
  tier            LicenseTier   @unique
  
  // Pricing
  monthlyPrice    Int           // in cents
  annualPrice     Int           // in cents
  
  // Limits
  maxUsers        Int
  maxProducts     Int
  maxApiCalls     Int
  maxStorage      BigInt
  
  // Features
  features        Json          @default("[]")
  
  // Stripe
  stripePriceId   String?
  
  // Status
  isActive        Boolean       @default(true)
  
  // Metadata
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@index([tier])
}

// Webhooks (for integrations)
model Webhook {
  id              String        @id @default(uuid())
  
  // Organization
  organizationId  String
  
  // Webhook Details
  url             String
  events          Json          @default("[]") // ["license.activated", "license.expired", etc.]
  secret          String
  
  // Status
  isActive        Boolean       @default(true)
  
  // Stats
  lastTriggered   DateTime?
  successCount    Int           @default(0)
  failureCount    Int           @default(0)
  
  // Metadata
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@index([organizationId])
}
// Agent Status
enum AgentStatus {
  ACTIVE
  OFFLINE
  ERROR
  MAINTENANCE
}

// Agents (iTechSmart Agent)
model Agent {
  id              String        @id @default(uuid())
  
  // Organization & License
  organizationId  String
  organization    Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  licenseId       String?
  license         License?      @relation(fields: [licenseId], references: [id], onDelete: SetNull)
  
  // Agent Details
  hostname        String
  ipAddress       String?
  osType          String        // linux, windows, darwin
  osVersion       String?
  agentVersion    String
  
  // Status
  status          AgentStatus   @default(ACTIVE)
  lastSeen        DateTime?
  
  // Configuration
  config          Json          @default("{}")
  
  // Authentication
  apiKey          String        @unique
  
  // Metadata
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  // Relations
  metrics         AgentMetric[]
  alerts          AgentAlert[]
  commands        AgentCommand[]
  
  @@unique([organizationId, hostname])
  @@index([organizationId])
  @@index([licenseId])
  @@index([status])
  @@index([lastSeen])
}

// Agent Metrics
model AgentMetric {
  id              String        @id @default(uuid())
  
  // Agent
  agentId         String
  agent           Agent         @relation(fields: [agentId], references: [id], onDelete: Cascade)
  
  // Metric Details
  metricType      String        // system, security, software, network
  metricData      Json
  
  // Timestamp
  timestamp       DateTime      @default(now())
  
  @@index([agentId])
  @@index([metricType])
  @@index([timestamp])
}

// Alert Severity
enum AlertSeverity {
  INFO
  WARNING
  ERROR
  CRITICAL
}

// Agent Alerts
model AgentAlert {
  id              String        @id @default(uuid())
  
  // Agent
  agentId         String
  agent           Agent         @relation(fields: [agentId], references: [id], onDelete: Cascade)
  
  // Alert Details
  alertType       String        // cpu, memory, disk, security, etc.
  severity        AlertSeverity
  message         String
  details         Json          @default("{}")
  
  // Resolution
  resolved        Boolean       @default(false)
  resolvedAt      DateTime?
  resolvedBy      String?
  
  // Metadata
  createdAt       DateTime      @default(now())
  
  @@index([agentId])
  @@index([alertType])
  @@index([severity])
  @@index([resolved])
  @@index([createdAt])
}

// Command Status
enum CommandStatus {
  PENDING
  SENT
  EXECUTING
  COMPLETED
  FAILED
  CANCELLED
}

// Agent Commands
model AgentCommand {
  id              String        @id @default(uuid())
  
  // Agent
  agentId         String
  agent           Agent         @relation(fields: [agentId], references: [id], onDelete: Cascade)
  
  // Command Details
  commandType     String        // execute, update_config, restart, etc.
  commandData     Json
  
  // Execution
  status          CommandStatus @default(PENDING)
  result          Json?
  error           String?
  
  // Timing
  createdAt       DateTime      @default(now())
  sentAt          DateTime?
  executedAt      DateTime?
  completedAt     DateTime?
  
  // Created By
  createdBy       String?       // user ID or system
  
  @@index([agentId])
  @@index([commandType])
  @@index([status])
  @@index([createdAt])
}
